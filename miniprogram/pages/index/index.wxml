<!--index.wxml-->
<view class="container">
  <!-- 安全区域适配 -->
  <view class="safe-area-top" style="height: {{safeAreaHeight}}rpx;"></view>

  <!-- 标题栏 -->
  <view class="header">
    <view class="title">
      自制创意DIY表情包
    </view>
  </view>

  <!-- 预览区域 -->
  <view class="preview-area">
    <view class="preview-content" id="previewContent">
      <!-- 默认提示文字 -->
      <view class="preview-layer default-hint" wx:if="{{!hasAnyContent}}">
        <view>
          <view>单指：滑动元素</view>
          <view>双指：缩放旋转</view>
          <view>点击：水平翻转</view>
        </view>
      </view>
      
      <!-- 身体图层 (最底层) -->
      <view
        class="preview-layer body-layer"
        wx:if="{{selectedBody}}"
        style="transform: {{bodyTransform}}; z-index: 1;"
        bindtouchstart="handleTouchStart"
        bindtouchmove="handleTouchMove"
        bindtouchend="handleTouchEnd"
        bindtap="handleLayerTap"
        data-layer="body"
      >
        <!-- 身体图片显示 - 使用更严格的条件判断 -->
        <!-- 如果是图片URL，使用image组件 -->
        <image
          wx:if="{{selectedBody && selectedBodyIsImage === true}}"
          src="{{selectedBody}}"
          mode="aspectFill"
          class="preview-custom-image"
          lazy-load="{{false}}"
          show-menu-by-longpress="{{false}}"
          binderror="handleImageError"
          bindload="handleImageLoad"
          data-image-src="{{selectedBody}}"
          data-layer="body"
          webp="{{true}}"
          fade-in="{{true}}"
        ></image>
        <!-- 如果是emoji文本，使用text显示 -->
        <text
          wx:elif="{{selectedBody && selectedBodyIsImage === false}}"
          class="preview-emoji-content"
        >{{selectedBody}}</text>

      </view>
      
      <!-- 表情图层 (中间层) -->
      <view
        class="preview-layer expression-layer"
        wx:if="{{selectedExpression}}"
        style="transform: {{expressionTransform}}; z-index: 2;"
        bindtouchstart="handleTouchStart"
        bindtouchmove="handleTouchMove"
        bindtouchend="handleTouchEnd"
        bindtap="handleLayerTap"
        data-layer="expression"
      >
        <!-- 表情显示 - 使用更严格的条件判断 -->
        <!-- 如果是图片URL，使用image组件 -->
        <image
          wx:if="{{selectedExpression && selectedExpressionIsImage === true}}"
          src="{{selectedExpression}}"
          mode="aspectFill"
          class="preview-custom-image"
          lazy-load="{{false}}"
          show-menu-by-longpress="{{false}}"
          binderror="handleImageError"
          bindload="handleImageLoad"
          data-image-src="{{selectedExpression}}"
          data-layer="expression"
          webp="{{true}}"
          fade-in="{{true}}"
        ></image>
        <!-- 如果是emoji文本，使用text显示 -->
        <text
          wx:elif="{{selectedExpression && selectedExpressionIsImage === false}}"
          class="preview-emoji-content"
        >{{selectedExpression}}</text>
      </view>
      
      <!-- 文字图层 (最顶层) -->
      <view 
        class="preview-layer text-layer" 
        wx:if="{{textContent}}"
        style="transform: {{textTransform}}; color: {{textColor}}; text-shadow: {{textShadow}}; z-index: 3;"
        bindtouchstart="handleTouchStart"
        bindtouchmove="handleTouchMove"
        bindtouchend="handleTouchEnd"
        bindtap="handleLayerTap"
        data-layer="text"
      >
        {{textContent}}
      </view>
    </view>
  </view>

  <!-- 功能标签栏 -->
  <view class="tab-bar">
    <view 
      class="tab-item {{currentTab === 'body' ? 'active' : ''}}" 
      bindtap="switchTab" 
      data-tab="body"
    >
      选身体
    </view>
    <view 
      class="tab-item {{currentTab === 'expression' ? 'active' : ''}}" 
      bindtap="switchTab" 
      data-tab="expression"
    >
      选表情
    </view>
    <view 
      class="tab-item {{currentTab === 'text' ? 'active' : ''}}" 
      bindtap="switchTab" 
      data-tab="text"
    >
      贴文字
    </view>
    <view 
      class="tab-item {{currentTab === 'generate' ? 'active' : ''}}" 
      bindtap="switchTab" 
      data-tab="generate"
    >
      发表情
    </view>
  </view>

  <!-- 内容区域 -->
  <view class="content-area" scroll-y="{{scrollEnabled}}">
    <!-- 选身体页面 -->
    <view class="tab-content {{currentTab === 'body' ? 'active' : ''}}" wx:if="{{currentTab === 'body'}}">
      <view class="category-tabs">
        <view
          class="category-tab {{bodyCurrentCategory === item.key ? 'active' : ''}}"
          wx:for="{{bodyCategories}}"
          wx:key="key"
          bindtap="updateCategory"
          data-category="{{item.key}}"
          data-type="body"
        >
          {{item.displayName}}
        </view>
      </view>
      
      <view class="material-grid">
        <view class="material-item upload" bindtap="handleUpload">
          <view>+<br/>上传</view>
        </view>
        <!-- 自定义上传的身体图片 -->
        <view
          class="material-item custom-image {{selectedBody === item.url ? 'selected' : ''}}"
          wx:for="{{customBodyImages}}"
          wx:key="id"
          bindtap="selectMaterial"
          data-type="body"
          data-image-url="{{item.url}}"
          bindlongpress="deleteCustomImage"
          data-image-id="{{item.id}}"
        >
          <image src="{{item.url}}" mode="aspectFill" class="custom-material-image"></image>
          <view class="delete-hint">长按删除</view>
          <!-- 编辑按钮 -->
          <view
            class="edit-btn {{selectedBody === item.url ? 'show' : ''}}"
            catchtap="editImage"
            data-image-src="{{item.url}}"
            data-image-id="{{item.id}}"
            data-image-type="body"
          >
            <view class="edit-icon">🖊️</view>
          </view>
        </view>
        <!-- 系统预设的身体素材 -->
        <view
          class="material-item {{selectedBody === item ? 'selected' : ''}}"
          wx:for="{{bodyMaterials}}"
          wx:key="*this"
          bindtap="selectMaterial"
          data-type="body"
          data-material="{{item}}"
        >
          {{item}}
        </view>
      </view>
    </view>

    <!-- 选表情页面 -->
    <view class="tab-content {{currentTab === 'expression' ? 'active' : ''}}" wx:if="{{currentTab === 'expression'}}">
      <view class="category-tabs">
        <view
          class="category-tab {{expressionCurrentCategory === item.key ? 'active' : ''}}"
          wx:for="{{expressionCategories}}"
          wx:key="key"
          bindtap="updateCategory"
          data-category="{{item.key}}"
          data-type="expression"
        >
          {{item.displayName}}
        </view>
      </view>
      
      <view class="material-grid">
        <view class="material-item upload" bindtap="handleUpload">
          <view>+<br/>上传</view>
        </view>
        <!-- 自定义上传的表情图片 -->
        <view
          class="material-item custom-image {{selectedExpression === item.url ? 'selected' : ''}}"
          wx:for="{{customExpressionImages}}"
          wx:key="id"
          bindtap="selectMaterial"
          data-type="expression"
          data-image-url="{{item.url}}"
          bindlongpress="deleteCustomImage"
          data-image-id="{{item.id}}"
        >
          <image src="{{item.url}}" mode="aspectFill" class="custom-material-image"></image>
          <view class="delete-hint">长按删除</view>
          <!-- 编辑按钮 -->
          <view
            class="edit-btn {{selectedExpression === item.url ? 'show' : ''}}"
            catchtap="editImage"
            data-image-src="{{item.url}}"
            data-image-id="{{item.id}}"
            data-image-type="expression"
          >
            <view class="edit-icon">🖊️</view>
          </view>
        </view>
        <!-- 系统预设的表情素材 -->
        <view
          class="material-item {{selectedExpression === item ? 'selected' : ''}}"
          wx:for="{{expressionMaterials}}"
          wx:key="*this"
          bindtap="selectMaterial"
          data-type="expression"
          data-material="{{item}}"
        >
          {{item}}
        </view>
      </view>
    </view>

    <!-- 贴文字页面 -->
    <view class="tab-content {{currentTab === 'text' ? 'active' : ''}}" wx:if="{{currentTab === 'text'}}">
      <input 
        class="text-input" 
        placeholder="点击输入" 
        value="{{textContent}}"
        bindinput="handleTextInput"
      />

      <view class="color-picker-section">
        <view class="color-picker" bindtouchstart="handleColorPickerTouch" bindtouchmove="handleColorPickerTouch" data-type="text">
          <view class="color-handle" style="left: {{textColorPosition}}%;"></view>
        </view>
      </view>

      <view class="toggle-section">
        <text>显示描边</text>
        <view class="toggle {{strokeEnabled ? '' : 'off'}}" bindtap="toggleStroke"></view>
      </view>

      <view class="color-picker-section">
        <view class="color-picker" bindtouchstart="handleColorPickerTouch" bindtouchmove="handleColorPickerTouch" data-type="stroke">
          <view class="color-handle" style="left: {{strokeColorPosition}}%;"></view>
        </view>
      </view>

      <view class="text-hint">
        「贴文字」支持换行，双指缩放调整大小和旋转
      </view>
    </view>

    <!-- 发表情页面 -->
    <view class="tab-content {{currentTab === 'generate' ? 'active' : ''}}" wx:if="{{currentTab === 'generate'}}">
      <view class="option-section">
        <view class="option-title">设置为透明背景</view>
      </view>

      <view class="option-section">
        <view class="option-buttons">
          <view class="option-btn {{generateSize === 'small' ? 'active' : ''}}" bindtap="selectGenerateOption" data-type="size" data-value="small">小尺寸</view>
          <view class="option-btn {{generateSize === 'medium' ? 'active' : ''}}" bindtap="selectGenerateOption" data-type="size" data-value="medium">中尺寸</view>
          <view class="option-btn {{generateSize === 'large' ? 'active' : ''}}" bindtap="selectGenerateOption" data-type="size" data-value="large">大尺寸</view>
        </view>
      </view>

      <view class="option-section">
        <view class="option-buttons">
          <view class="option-btn {{generateQuality === 'suitable' ? 'active' : ''}}" bindtap="selectGenerateOption" data-type="quality" data-value="suitable">适宜</view>
          <view class="option-btn {{generateQuality === 'compress' ? 'active' : ''}}" bindtap="selectGenerateOption" data-type="quality" data-value="compress">压缩</view>
          <view class="option-btn {{generateQuality === 'lossless' ? 'active' : ''}}" bindtap="selectGenerateOption" data-type="quality" data-value="lossless">无损</view>
        </view>
      </view>

      <button class="generate-btn" bindtap="generateEmoji">生成</button>

      <view class="feedback-link" bindtap="handleFeedback">问题反馈</view>
    </view>
  </view>

  <!-- 底部导航 -->
  <view class="bottom-nav">
    <view class="nav-item active">
      <view class="nav-icon"></view>
      <view>制作表情</view>
    </view>
    <view class="nav-item">
      <view class="nav-icon"></view>
      <view>表情广场</view>
    </view>
    <view class="nav-item debug-nav" bindtap="goToTest">
      <view class="nav-icon debug-icon">🧪</view>
      <view>调试工具</view>
    </view>
  </view>
</view>
