<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIY创意表情包</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 全新配色方案变量定义 */
        :root {
            /* 主色调 */
            --primary-color: #FF6B6B;
            --primary-hover: #FF5252;
            --primary-active: #E53E3E;

            /* 次要色调 */
            --secondary-color: #FFE66D;
            --secondary-hover: #FFD93D;
            --secondary-active: #FFC107;

            /* 强调色 */
            --accent-color: #9C88FF;
            --accent-hover: #8B7CF6;
            --accent-active: #7C3AED;

            /* 文字颜色 */
            --text-primary: #2D3748;
            --text-secondary: #4A5568;
            --text-hint: #718096;
            --text-inverse: #FFFFFF;
            --text-link: #3182CE;

            /* 状态色 */
            --success-color: #48BB78;
            --warning-color: #ED8936;
            --error-color: #F56565;
            --info-color: #4299E1;

            /* 背景色 */
            --card-bg: #FFFFFF;
            --container-secondary: #F7FAFC;
            --input-bg: #FFFFFF;
            --input-border: #E2E8F0;
            --divider-color: #E2E8F0;

            /* 选中状态 */
            --selected-bg: rgba(255, 107, 107, 0.1);
            --hover-overlay: rgba(255, 255, 255, 0.1);
            --active-overlay: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #FF6B6B 0%, #FFE66D 50%, #FF8E53 100%);
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .container {
            width: 375px;
            height: 812px;
            margin: 0 auto;
            background: linear-gradient(135deg, #00C851 0%, #00FF7F 100%);
            position: relative;
            overflow: hidden;
        }

        /* 状态栏 */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 20px;
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .status-left {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-right {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 标题栏 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            color: white;
        }

        .title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-icons {
            display: flex;
            gap: 15px;
        }

        .icon {
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* 预览区域 */
        .preview-area {
            margin: 20px;
            background: white;
            border-radius: 12px;
            height: 280px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .preview-content {
            text-align: center;
            color: #999;
            line-height: 1.6;
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 图层元素样式 */
        .preview-layer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .body-layer {
            z-index: 1;
            font-size: 48px;
        }

        .expression-layer {
            z-index: 2;
            font-size: 48px;
        }

        .text-layer {
            z-index: 3;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            white-space: pre-wrap;
            max-width: 200px;
        }

        .default-hint {
            z-index: 0;
            color: #999;
            line-height: 1.6;
        }

        .preview-image {
            width: 150px;
            height: 150px;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        /* 功能标签栏 */
        .tab-bar {
            display: flex;
            padding: 0 20px;
            margin-bottom: 10px;
        }

        .tab-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            color: rgba(255,255,255,0.7);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-radius: 8px;
            margin: 0 4px;
        }

        .tab-item:hover:not(.active) {
            color: rgba(255,255,255,0.9);
            background: var(--hover-overlay);
        }

        .tab-item.active {
            color: var(--text-inverse);
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            box-shadow: 0 2px 8px rgba(156, 136, 255, 0.3);
        }

        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 3px;
            background: var(--secondary-color);
            border-radius: 2px;
        }

        /* 内容区域 */
        .content-area {
            background: var(--container-secondary);
            border-radius: 20px 20px 0 0;
            flex: 1;
            padding: 20px 20px 80px 20px; /* 增加底部padding避免被导航栏遮挡 */
            overflow-y: auto;
            margin-bottom: 0;
        }

        /* 分类标签 */
        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .category-tab {
            padding: 10px 18px;
            background: var(--card-bg);
            border-radius: 25px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .category-tab:hover:not(.active) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            color: var(--text-primary);
        }

        .category-tab.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-inverse);
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 107, 107, 0.3);
        }

        /* 素材网格 */
        .material-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .material-item {
            aspect-ratio: 1;
            background: var(--card-bg);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
        }

        .material-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .material-item:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .material-item:hover::before {
            opacity: 1;
        }

        .material-item.selected {
            border: 3px solid;
            border-image: linear-gradient(135deg, var(--primary-color), var(--accent-color), var(--secondary-color)) 1;
            transform: scale(1.02) translateY(-1px);
            box-shadow: 0 6px 16px rgba(255, 107, 107, 0.3);
        }

        .material-item.upload {
            border: 2px dashed var(--text-hint);
            color: var(--text-hint);
            font-size: 12px;
            text-align: center;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .material-item.upload:hover {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background: linear-gradient(135deg, #f1f3f4, #e8eaed);
        }

        /* 底部导航 */
        .bottom-nav {
            display: flex;
            background: var(--card-bg);
            padding: 12px 0;
            border-top: 1px solid var(--divider-color);
            position: relative;
            z-index: 10;
            margin-top: auto;
            box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.08);
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px 0;
            color: var(--text-hint);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 0 8px;
        }

        .nav-item:hover:not(.active) {
            color: var(--text-secondary);
            background: var(--container-secondary);
        }

        .nav-item.active {
            color: var(--primary-color);
            background: var(--selected-bg);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin: 0 auto 4px;
            background: var(--text-hint);
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .nav-item.active .nav-icon {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
        }

        /* 隐藏其他页面内容 */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 文字编辑页面样式 */
        .text-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--input-border);
            border-radius: 12px;
            font-size: 16px;
            margin-bottom: 24px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .text-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(156, 136, 255, 0.1);
        }

        .color-picker-section {
            margin-bottom: 24px;
        }

        .color-picker {
            width: 100%;
            height: 44px;
            border-radius: 22px;
            background: linear-gradient(to right, #000, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #fff);
            margin-bottom: 16px;
            position: relative;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .color-handle {
            width: 24px;
            height: 24px;
            background: var(--card-bg);
            border: 3px solid var(--text-primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .color-handle:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .toggle-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .toggle {
            width: 54px;
            height: 32px;
            background: var(--success-color);
            border-radius: 16px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3);
        }

        .toggle::after {
            content: '';
            width: 28px;
            height: 28px;
            background: var(--card-bg);
            border-radius: 50%;
            position: absolute;
            top: 2px;
            right: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .toggle.off {
            background: var(--text-hint);
            box-shadow: 0 2px 8px rgba(113, 128, 150, 0.2);
        }

        .toggle.off::after {
            right: 24px;
        }

        .text-hint {
            color: var(--text-hint);
            font-size: 13px;
            text-align: center;
            margin-top: 24px;
            line-height: 1.5;
            background: var(--card-bg);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid var(--accent-color);
        }

        /* 生成页面样式 */
        .generate-preview {
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20"><rect width="10" height="10" fill="%23f0f0f0"/><rect x="10" y="10" width="10" height="10" fill="%23f0f0f0"/></svg>');
            border-radius: 12px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }

        .generate-content {
            width: 120px;
            height: 120px;
            background: transparent;
            border-radius: 8px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 生成页面的图层样式 */
        .generate-layer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .generate-body-layer {
            z-index: 1;
            font-size: 48px;
        }

        .generate-expression-layer {
            z-index: 2;
            font-size: 48px;
        }

        .generate-text-layer {
            z-index: 3;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            white-space: pre-wrap;
            max-width: 100px;
        }

        .option-section {
            margin-bottom: 20px;
        }

        .option-title {
            font-size: 16px;
            margin-bottom: 16px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .option-buttons {
            display: flex;
            gap: 12px;
        }

        .option-btn {
            flex: 1;
            padding: 14px 12px;
            background: var(--card-bg);
            border: 2px solid var(--input-border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .option-btn:hover:not(.active) {
            border-color: var(--accent-color);
            color: var(--text-primary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .option-btn.active {
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            color: var(--text-inverse);
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(156, 136, 255, 0.3);
        }

        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-inverse);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(255, 107, 107, 0.3);
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 107, 107, 0.4);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .feedback-link {
            text-align: center;
            color: var(--text-link);
            font-size: 14px;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .feedback-link:hover {
            color: var(--primary-color);
        }

        /* 触摸交互样式 */
        .preview-layer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: none;
        }

        .preview-layer.interactive {
            transition: none;
        }

        .preview-layer.flipping {
            transition: transform 0.3s ease;
        }

        .body-layer {
            z-index: 1;
            font-size: 48px;
        }

        .expression-layer {
            z-index: 2;
            font-size: 48px;
        }

        .text-layer {
            z-index: 3;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            white-space: pre-wrap;
            max-width: 100px;
        }

        .default-hint {
            z-index: 0;
            color: #999;
            font-size: 14px;
            text-align: center;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 状态栏 -->
        <div class="status-bar">
            <div class="status-left">
                <span>19:39</span>
                <span>🔶</span>
                <span>📶</span>
                <span>📶</span>
            </div>
            <div class="status-right">
                <span>🏠</span>
                <span>🔵</span>
                <span>100%</span>
                <span>📶</span>
                <span>📶</span>
                <span>49</span>
            </div>
        </div>

        <!-- 标题栏 -->
        <div class="header">
            <div class="title">
                自制创意DIY表情包 📱
            </div>
            <div class="header-icons">
                <div class="icon">⋯</div>
                <div class="icon">—</div>
                <div class="icon">⊙</div>
            </div>
        </div>

        <!-- 预览区域 -->
        <div class="preview-area">
            <div class="preview-content" id="previewContent">
                <!-- 默认提示文字 -->
                <div class="preview-layer default-hint" id="defaultHint">
                    <div>
                        <div>单指：滑动元素</div>
                        <div>双指：缩放旋转</div>
                        <div>点击：水平翻转</div>
                    </div>
                </div>
                <!-- 身体图层 (最底层) -->
                <div class="preview-layer body-layer" id="bodyLayer" style="display: none;"></div>
                <!-- 表情图层 (中间层) -->
                <div class="preview-layer expression-layer" id="expressionLayer" style="display: none;"></div>
                <!-- 文字图层 (最顶层) -->
                <div class="preview-layer text-layer" id="textLayer" style="display: none;"></div>
            </div>
        </div>

        <!-- 功能标签栏 -->
        <div class="tab-bar">
            <div class="tab-item active" data-tab="body">选身体</div>
            <div class="tab-item" data-tab="expression">选表情</div>
            <div class="tab-item" data-tab="text">贴文字</div>
            <div class="tab-item" data-tab="generate">发表情</div>
        </div>

        <!-- 内容区域 -->
        <div class="content-area">
            <!-- 选身体页面 -->
            <div class="tab-content active" id="bodyTab">
                <div class="category-tabs">
                    <div class="category-tab active" data-category="panda">熊猫</div>
                    <div class="category-tab" data-category="mushroom">蘑菇头</div>
                    <div class="category-tab" data-category="round">圆脸</div>
                    <div class="category-tab" data-category="rabbit">兔子</div>
                    <div class="category-tab" data-category="dark">黑暗势力</div>
                    <div class="category-tab" data-category="comic">漫画</div>
                </div>
                <div class="material-grid" id="bodyGrid">
                    <div class="material-item upload">
                        <div>+<br>上传</div>
                    </div>
                    <!-- 表情素材将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 选表情页面 -->
            <div class="tab-content" id="expressionTab">
                <div class="category-tabs">
                    <div class="category-tab active" data-category="happy">开心</div>
                    <div class="category-tab" data-category="sad">难过</div>
                    <div class="category-tab" data-category="angry">愤怒</div>
                    <div class="category-tab" data-category="love">爱心</div>
                    <div class="category-tab" data-category="surprise">惊讶</div>
                </div>
                <div class="material-grid" id="expressionGrid">
                    <div class="material-item upload">
                        <div>+<br>上传</div>
                    </div>
                    <!-- 表情素材将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 贴文字页面 -->
            <div class="tab-content" id="textTab">
                <input type="text" class="text-input" placeholder="点击输入" id="textInput">

                <div class="color-picker-section">
                    <div class="color-picker" id="textColorPicker">
                        <div class="color-handle" id="textColorHandle" style="left: 10px;"></div>
                    </div>
                </div>

                <div class="toggle-section">
                    <span>显示描边</span>
                    <div class="toggle" id="strokeToggle">
                    </div>
                </div>

                <div class="color-picker-section">
                    <div class="color-picker" id="strokeColorPicker">
                        <div class="color-handle" id="strokeColorHandle" style="left: 10px;"></div>
                    </div>
                </div>

                <div class="text-hint">
                    「贴文字」支持换行，双指缩放调整大小和旋转
                </div>
            </div>

            <!-- 发表情页面 -->
            <div class="tab-content" id="generateTab">
                <div class="generate-preview">
                    <div class="generate-content" id="generateContent">
                        <!-- 身体图层 (最底层) -->
                        <div class="generate-layer generate-body-layer" id="generateBodyLayer" style="display: none;"></div>
                        <!-- 表情图层 (中间层) -->
                        <div class="generate-layer generate-expression-layer" id="generateExpressionLayer" style="display: none;"></div>
                        <!-- 文字图层 (最顶层) -->
                        <div class="generate-layer generate-text-layer" id="generateTextLayer" style="display: none;"></div>
                    </div>
                </div>

                <div class="option-section">
                    <div class="option-title">设置为透明背景</div>
                </div>

                <div class="option-section">
                    <div class="option-buttons">
                        <div class="option-btn active" data-size="small">小尺寸</div>
                        <div class="option-btn" data-size="medium">中尺寸</div>
                        <div class="option-btn" data-size="large">大尺寸</div>
                    </div>
                </div>

                <div class="option-section">
                    <div class="option-buttons">
                        <div class="option-btn active" data-quality="suitable">适宜</div>
                        <div class="option-btn" data-quality="compress">压缩</div>
                        <div class="option-btn" data-quality="lossless">无损</div>
                    </div>
                </div>

                <button class="generate-btn" id="generateBtn">生成</button>

                <div class="feedback-link">问题反馈</div>
            </div>
        </div>

        <!-- 底部导航 -->
        <div class="bottom-nav">
            <div class="nav-item active">
                <div class="nav-icon"></div>
                <div>制作表情</div>
            </div>
            <div class="nav-item">
                <div class="nav-icon"></div>
                <div>表情广场</div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentTab = 'body';
        let currentCategory = 'panda';
        let selectedBody = null;
        let selectedExpression = null;
        let textContent = '';
        let textColor = '#000000';
        let strokeEnabled = true;
        let strokeColor = '#ffffff';

        // 触摸交互变量
        let layerTransforms = {
            body: { x: 0, y: 0, scale: 1, rotation: 0, flipX: false },
            expression: { x: 0, y: 0, scale: 1, rotation: 0, flipX: false },
            text: { x: 0, y: 0, scale: 1, rotation: 0, flipX: false }
        };

        let touchState = {
            isDragging: false,
            isScaling: false,
            activeLayer: null,
            startTouches: [],
            lastTouches: [],
            initialDistance: 0,
            initialAngle: 0,
            initialTransform: null
        };

        // 素材数据
        const materials = {
            panda: ['🐼', '🐾', '🎋', '🎍', '🍃', '🌿', '🌱', '🌾', '🎄', '🌲', '🌳', '🌴', '🌵', '🌶️', '🥒'],
            mushroom: ['🍄', '🟫', '🟤', '🤎', '🟠', '🟡', '🟢', '🔵', '🟣', '🟥', '🟧', '🟨', '🟩', '🟦', '🟪'],
            round: ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇', '🙂', '🙃', '😉', '😌', '😍'],
            rabbit: ['🐰', '🐇', '🥕', '🌸', '🌺', '🌻', '🌷', '🌹', '💐', '🌼', '🌾', '🍀', '🌿', '🌱', '🌳'],
            dark: ['😈', '👿', '💀', '☠️', '👻', '👽', '👾', '🤖', '💩', '😡', '🤬', '😠', '👹', '👺', '🔥'],
            comic: ['💥', '💫', '⭐', '🌟', '✨', '⚡', '🔥', '💢', '💨', '💦', '💧', '🌈', '☀️', '🌙', '⭐']
        };

        // 表情数据
        const expressions = {
            happy: ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇', '🙂', '🙃', '😉', '😌', '😍', '🥰', '😋', '😎', '🤩', '🥳'],
            sad: ['😢', '😭', '😿', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣', '😖', '😫', '😩', '🥺', '😪', '😴', '😵', '🤧', '🤒', '🤕'],
            angry: ['😠', '😡', '🤬', '😤', '👿', '💢', '🔥', '💥', '⚡', '👹', '👺', '😈', '🤯', '😵', '🥵', '😾', '🙄', '😒', '😮‍💨', '💀'],
            love: ['😍', '🥰', '😘', '😗', '😙', '😚', '💕', '💖', '💗', '💘', '💝', '💞', '💟', '❤️', '🧡', '💛', '💚', '💙', '💜', '🤍'],
            surprise: ['😲', '😱', '🤯', '😵', '🤪', '🤨', '🧐', '🤓', '😎', '🤩', '🥳', '😜', '😝', '😛', '🤤', '🤭', '🫢', '🫣', '🤫', '🤗']
        };

        // 应用变换到图层
        function applyTransform(layer, layerType) {
            const transform = layerTransforms[layerType];
            const scaleX = transform.flipX ? -transform.scale : transform.scale;

            layer.style.transform = `
                translate(calc(-50% + ${transform.x}px), calc(-50% + ${transform.y}px))
                scale(${scaleX}, ${transform.scale})
                rotate(${transform.rotation}deg)
            `;
        }

        // 边界约束
        function constrainToBounds(layerType) {
            const previewContent = document.getElementById('previewContent');
            const rect = previewContent.getBoundingClientRect();

            const maxX = rect.width / 4;
            const maxY = rect.height / 4;

            layerTransforms[layerType].x = Math.max(-maxX, Math.min(maxX, layerTransforms[layerType].x));
            layerTransforms[layerType].y = Math.max(-maxY, Math.min(maxY, layerTransforms[layerType].y));
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            initializeTabs();
            initializeMaterials();
            initializeColorPickers();
            initializeToggles();
            initializeOptions();
            initializeDefaultColors();
            initializeTouchInteraction();
        });

        // 初始化默认颜色
        function initializeDefaultColors() {
            // 设置文字颜色为黑色 (0%)
            const textColorHandle = document.getElementById('textColorHandle');
            if (textColorHandle) {
                textColorHandle.style.left = '0%';
                textColor = '#000000';
            }

            // 设置描边颜色为白色 (100%)
            const strokeColorHandle = document.getElementById('strokeColorHandle');
            if (strokeColorHandle) {
                strokeColorHandle.style.left = '100%';
                strokeColor = '#ffffff';
            }
        }

        // 初始化标签页切换
        function initializeTabs() {
            const tabItems = document.querySelectorAll('.tab-item');
            tabItems.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
        }

        // 切换标签页
        function switchTab(tabName) {
            // 更新标签状态
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // 更新内容区域
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');

            currentTab = tabName;

            // 根据标签页设置默认分类
            if (tabName === 'body') {
                currentCategory = 'panda';
            } else if (tabName === 'expression') {
                currentCategory = 'happy';
            }

            updatePreview();
        }

        // 初始化素材网格
        function initializeMaterials() {
            generateMaterialGrid('body', 'panda');
            generateMaterialGrid('expression', 'happy');

            // 分类标签点击事件
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const category = this.dataset.category || this.textContent.toLowerCase();
                    updateCategory(category);
                });
            });

            // 初始化上传按钮事件
            document.querySelectorAll('.upload').forEach(uploadBtn => {
                uploadBtn.addEventListener('click', function() {
                    alert('上传功能暂未开放');
                });
            });
        }

        // 生成素材网格
        function generateMaterialGrid(gridType, category) {
            const gridId = gridType === 'body' ? 'bodyGrid' : 'expressionGrid';
            const grid = document.getElementById(gridId);
            const materialList = gridType === 'body' ?
                (materials[category] || materials.panda) :
                (expressions[category] || expressions.happy);

            // 清空现有内容（保留上传按钮）
            const uploadBtn = grid.querySelector('.upload');
            const uploadBtnHTML = uploadBtn ? uploadBtn.outerHTML : '';
            grid.innerHTML = '';

            // 重新添加上传按钮
            if (uploadBtnHTML) {
                grid.innerHTML = uploadBtnHTML;
                // 重新绑定上传按钮事件
                const newUploadBtn = grid.querySelector('.upload');
                if (newUploadBtn) {
                    newUploadBtn.addEventListener('click', function() {
                        alert('上传功能暂未开放');
                    });
                }
            }

            // 添加素材项
            materialList.forEach(material => {
                const item = document.createElement('div');
                item.className = 'material-item';
                item.textContent = material;
                item.style.fontSize = '24px';
                item.addEventListener('click', function() {
                    selectMaterial(gridType, material);
                });
                grid.appendChild(item);
            });
        }

        // 选择素材
        function selectMaterial(type, material) {
            if (type === 'body') {
                selectedBody = material;
                // 更新选中状态
                const bodyGrid = document.getElementById('bodyGrid');
                bodyGrid.querySelectorAll('.material-item:not(.upload)').forEach(item => {
                    item.classList.remove('selected');
                    if (item.textContent === material) {
                        item.classList.add('selected');
                    }
                });
            } else {
                selectedExpression = material;
                // 更新选中状态
                const expressionGrid = document.getElementById('expressionGrid');
                expressionGrid.querySelectorAll('.material-item:not(.upload)').forEach(item => {
                    item.classList.remove('selected');
                    if (item.textContent === material) {
                        item.classList.add('selected');
                    }
                });
            }
            updatePreview();
        }

        // 更新分类
        function updateCategory(category) {
            // 中文分类映射
            const categoryMap = {
                '开心': 'happy',
                '难过': 'sad',
                '愤怒': 'angry',
                '爱心': 'love',
                '惊讶': 'surprise',
                '熊猫': 'panda',
                '蘑菇头': 'mushroom',
                '圆脸': 'round',
                '兔子': 'rabbit',
                '黑暗势力': 'dark',
                '漫画': 'comic'
            };

            // 如果是中文分类名，转换为英文key
            const mappedCategory = categoryMap[category] || category;

            // 更新分类标签状态
            const parentTab = document.querySelector('.tab-content.active');
            parentTab.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            const activeTab = parentTab.querySelector(`[data-category="${mappedCategory}"]`) ||
                             Array.from(parentTab.querySelectorAll('.category-tab')).find(tab =>
                                 categoryMap[tab.textContent] === mappedCategory ||
                                 tab.textContent.toLowerCase() === mappedCategory.toLowerCase());
            if (activeTab) {
                activeTab.classList.add('active');
            }

            currentCategory = mappedCategory;

            // 重新生成素材网格
            if (currentTab === 'body') {
                generateMaterialGrid('body', mappedCategory);
            } else if (currentTab === 'expression') {
                generateMaterialGrid('expression', mappedCategory);
            }
        }

        // 初始化颜色选择器
        function initializeColorPickers() {
            const textColorPicker = document.getElementById('textColorPicker');
            const strokeColorPicker = document.getElementById('strokeColorPicker');

            if (textColorPicker) {
                initializeColorPickerEvents(textColorPicker, 'textColorHandle');
            }

            if (strokeColorPicker) {
                initializeColorPickerEvents(strokeColorPicker, 'strokeColorHandle');
            }

            // 文本输入事件
            const textInput = document.getElementById('textInput');
            if (textInput) {
                textInput.addEventListener('input', function() {
                    textContent = this.value;
                    updatePreview();
                });
            }
        }

        // 初始化单个颜色选择器的事件
        function initializeColorPickerEvents(picker, handleId) {
            let isDragging = false;

            // 点击事件
            picker.addEventListener('click', function(e) {
                updateColorHandle(e, handleId);
            });

            // 鼠标按下事件
            picker.addEventListener('mousedown', function(e) {
                isDragging = true;
                updateColorHandle(e, handleId);
                e.preventDefault();
            });

            // 鼠标移动事件
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    const rect = picker.getBoundingClientRect();
                    if (e.clientX >= rect.left && e.clientX <= rect.right) {
                        updateColorHandle(e, handleId);
                    }
                }
            });

            // 鼠标释放事件
            document.addEventListener('mouseup', function() {
                isDragging = false;
            });

            // 触摸事件支持
            picker.addEventListener('touchstart', function(e) {
                isDragging = true;
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                updateColorHandle(mouseEvent, handleId);
                e.preventDefault();
            });

            document.addEventListener('touchmove', function(e) {
                if (isDragging) {
                    const touch = e.touches[0];
                    const rect = picker.getBoundingClientRect();
                    if (touch.clientX >= rect.left && touch.clientX <= rect.right) {
                        const mouseEvent = new MouseEvent('mousemove', {
                            clientX: touch.clientX,
                            clientY: touch.clientY
                        });
                        updateColorHandle(mouseEvent, handleId);
                    }
                }
            });

            document.addEventListener('touchend', function() {
                isDragging = false;
            });
        }

        // 更新颜色手柄位置并计算颜色
        function updateColorHandle(e, handleId) {
            // 获取颜色选择器的位置信息
            const colorPicker = document.getElementById(handleId).parentElement;
            const rect = colorPicker.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percentage = Math.max(0, Math.min(100, (x / rect.width) * 100));

            const handle = document.getElementById(handleId);
            handle.style.left = percentage + '%';

            // 计算颜色值
            const color = calculateColorFromPercentage(percentage);

            // 更新对应的颜色变量
            if (handleId === 'textColorHandle') {
                textColor = color;
            } else if (handleId === 'strokeColorHandle') {
                strokeColor = color;
            }

            // 更新预览
            updatePreview();
        }

        // 根据百分比计算颜色值
        function calculateColorFromPercentage(percentage) {
            // 彩虹色谱：黑 -> 红 -> 黄 -> 绿 -> 青 -> 蓝 -> 紫 -> 白
            const colors = [
                { r: 0, g: 0, b: 0 },       // 黑色 0%
                { r: 255, g: 0, b: 0 },     // 红色 14.3%
                { r: 255, g: 255, b: 0 },   // 黄色 28.6%
                { r: 0, g: 255, b: 0 },     // 绿色 42.9%
                { r: 0, g: 255, b: 255 },   // 青色 57.1%
                { r: 0, g: 0, b: 255 },     // 蓝色 71.4%
                { r: 255, g: 0, b: 255 },   // 紫色 85.7%
                { r: 255, g: 255, b: 255 }  // 白色 100%
            ];

            const segmentSize = 100 / (colors.length - 1);
            const segmentIndex = Math.floor(percentage / segmentSize);
            const segmentProgress = (percentage % segmentSize) / segmentSize;

            if (segmentIndex >= colors.length - 1) {
                return `rgb(${colors[colors.length - 1].r}, ${colors[colors.length - 1].g}, ${colors[colors.length - 1].b})`;
            }

            const startColor = colors[segmentIndex];
            const endColor = colors[segmentIndex + 1];

            const r = Math.round(startColor.r + (endColor.r - startColor.r) * segmentProgress);
            const g = Math.round(startColor.g + (endColor.g - startColor.g) * segmentProgress);
            const b = Math.round(startColor.b + (endColor.b - startColor.b) * segmentProgress);

            return `rgb(${r}, ${g}, ${b})`;
        }

        // 初始化开关
        function initializeToggles() {
            const strokeToggle = document.getElementById('strokeToggle');
            if (strokeToggle) {
                strokeToggle.addEventListener('click', function() {
                    strokeEnabled = !strokeEnabled;
                    this.classList.toggle('off', !strokeEnabled);
                });
            }
        }

        // 初始化选项按钮
        function initializeOptions() {
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const parent = this.parentElement;
                    parent.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            const generateBtn = document.getElementById('generateBtn');
            if (generateBtn) {
                generateBtn.addEventListener('click', function() {
                    alert('表情包生成完成！');
                });
            }
        }

        // 更新预览
        function updatePreview() {
            const bodyLayer = document.getElementById('bodyLayer');
            const expressionLayer = document.getElementById('expressionLayer');
            const textLayer = document.getElementById('textLayer');
            const defaultHint = document.getElementById('defaultHint');

            // 更新生成页面
            if (currentTab === 'generate') {
                updateGeneratePreview();
                return;
            }

            // 更新图层显示
            updateLayerVisibility();

            // 更新身体图层
            if (selectedBody) {
                bodyLayer.textContent = selectedBody;
                bodyLayer.style.display = 'flex';
                applyTransform(bodyLayer, 'body');
            } else {
                bodyLayer.style.display = 'none';
            }

            // 更新表情图层
            if (selectedExpression) {
                expressionLayer.textContent = selectedExpression;
                expressionLayer.style.display = 'flex';
                applyTransform(expressionLayer, 'expression');
            } else {
                expressionLayer.style.display = 'none';
            }

            // 更新文字图层
            if (textContent) {
                textLayer.textContent = textContent;
                textLayer.style.color = textColor;

                // 应用描边效果
                if (strokeEnabled) {
                    textLayer.style.textShadow = `
                        -1px -1px 0 ${strokeColor},
                        1px -1px 0 ${strokeColor},
                        -1px 1px 0 ${strokeColor},
                        1px 1px 0 ${strokeColor},
                        -2px 0 0 ${strokeColor},
                        2px 0 0 ${strokeColor},
                        0 -2px 0 ${strokeColor},
                        0 2px 0 ${strokeColor}
                    `;
                } else {
                    textLayer.style.textShadow = 'none';
                }

                textLayer.style.display = 'flex';
                applyTransform(textLayer, 'text');
            } else {
                textLayer.style.display = 'none';
            }

            // 控制默认提示的显示
            let hasAnyContent = false;
            let hintText = '请选择素材';

            if (currentTab === 'body') {
                hasAnyContent = selectedBody;
                hintText = '请选择身体素材';
            } else if (currentTab === 'expression') {
                hasAnyContent = selectedExpression;
                hintText = '请选择表情素材';
            } else if (currentTab === 'text') {
                hasAnyContent = textContent;
                hintText = '请输入文字内容';
            } else {
                hasAnyContent = selectedBody || selectedExpression || textContent;
                hintText = '请选择素材';
            }

            defaultHint.style.display = hasAnyContent ? 'none' : 'flex';
            defaultHint.textContent = hintText;
        }

        // 更新图层可见性
        function updateLayerVisibility() {
            const bodyLayer = document.getElementById('bodyLayer');
            const expressionLayer = document.getElementById('expressionLayer');
            const textLayer = document.getElementById('textLayer');

            // 确保图层按正确的z-index顺序显示
            bodyLayer.style.zIndex = '1';
            expressionLayer.style.zIndex = '2';
            textLayer.style.zIndex = '3';
        }

        // 更新生成页面预览
        function updateGeneratePreview() {
            const generateBodyLayer = document.getElementById('generateBodyLayer');
            const generateExpressionLayer = document.getElementById('generateExpressionLayer');
            const generateTextLayer = document.getElementById('generateTextLayer');

            // 更新身体图层
            if (selectedBody) {
                generateBodyLayer.textContent = selectedBody;
                generateBodyLayer.style.display = 'flex';
            } else {
                generateBodyLayer.style.display = 'none';
            }

            // 更新表情图层
            if (selectedExpression) {
                generateExpressionLayer.textContent = selectedExpression;
                generateExpressionLayer.style.display = 'flex';
            } else {
                generateExpressionLayer.style.display = 'none';
            }

            // 更新文字图层
            if (textContent) {
                generateTextLayer.textContent = textContent;
                generateTextLayer.style.color = textColor;

                // 应用描边效果
                if (strokeEnabled) {
                    generateTextLayer.style.textShadow = `
                        -1px -1px 0 ${strokeColor},
                        1px -1px 0 ${strokeColor},
                        -1px 1px 0 ${strokeColor},
                        1px 1px 0 ${strokeColor},
                        -2px 0 0 ${strokeColor},
                        2px 0 0 ${strokeColor},
                        0 -2px 0 ${strokeColor},
                        0 2px 0 ${strokeColor}
                    `;
                } else {
                    generateTextLayer.style.textShadow = 'none';
                }

                generateTextLayer.style.display = 'flex';
            } else {
                generateTextLayer.style.display = 'none';
            }

            // 确保生成页面图层按正确的z-index顺序显示
            generateBodyLayer.style.zIndex = '1';
            generateExpressionLayer.style.zIndex = '2';
            generateTextLayer.style.zIndex = '3';
        }

        // 初始化触摸交互
        function initializeTouchInteraction() {
            const layers = ['bodyLayer', 'expressionLayer', 'textLayer'];

            layers.forEach(layerId => {
                const layer = document.getElementById(layerId);
                if (layer) {
                    // 添加触摸事件监听器
                    layer.addEventListener('touchstart', handleTouchStart, { passive: false });
                    layer.addEventListener('touchmove', handleTouchMove, { passive: false });
                    layer.addEventListener('touchend', handleTouchEnd, { passive: false });

                    // 添加鼠标事件监听器（用于桌面测试）
                    layer.addEventListener('mousedown', handleMouseDown);
                    layer.addEventListener('mousemove', handleMouseMove);
                    layer.addEventListener('mouseup', handleMouseUp);

                    // 添加点击事件监听器（水平翻转）
                    layer.addEventListener('click', handleLayerClick);
                }
            });
        }
        // 触摸开始事件处理
        function handleTouchStart(e) {
            e.preventDefault();
            const layerType = getLayerType(e.target);
            if (!layerType) return;

            touchState.activeLayer = layerType;
            touchState.startTouches = Array.from(e.touches);
            touchState.lastTouches = Array.from(e.touches);
            touchState.initialTransform = { ...layerTransforms[layerType] };

            if (e.touches.length === 1) {
                touchState.isDragging = true;
                e.target.classList.add('interactive');
            } else if (e.touches.length === 2) {
                touchState.isScaling = true;
                touchState.initialDistance = getTouchDistance(e.touches[0], e.touches[1]);
                touchState.initialAngle = getTouchAngle(e.touches[0], e.touches[1]);
                e.target.classList.add('interactive');
            }
        }

        // 触摸移动事件处理
        function handleTouchMove(e) {
            e.preventDefault();
            if (!touchState.activeLayer) return;

            const layerType = touchState.activeLayer;
            const layer = document.getElementById(layerType + 'Layer');

            if (touchState.isDragging && e.touches.length === 1) {
                // 单指拖拽
                const touch = e.touches[0];
                const lastTouch = touchState.lastTouches[0];

                const deltaX = touch.clientX - lastTouch.clientX;
                const deltaY = touch.clientY - lastTouch.clientY;

                layerTransforms[layerType].x += deltaX;
                layerTransforms[layerType].y += deltaY;

                // 边界检测
                constrainToBounds(layerType);

                applyTransform(layer, layerType);
                touchState.lastTouches = Array.from(e.touches);

            } else if (touchState.isScaling && e.touches.length === 2) {
                // 双指缩放和旋转
                const currentDistance = getTouchDistance(e.touches[0], e.touches[1]);
                const currentAngle = getTouchAngle(e.touches[0], e.touches[1]);

                // 计算缩放比例
                const scaleChange = currentDistance / touchState.initialDistance;
                let newScale = touchState.initialTransform.scale * scaleChange;
                newScale = Math.max(0.5, Math.min(3, newScale)); // 限制缩放范围

                // 计算旋转角度
                const rotationChange = currentAngle - touchState.initialAngle;
                const newRotation = touchState.initialTransform.rotation + rotationChange;

                layerTransforms[layerType].scale = newScale;
                layerTransforms[layerType].rotation = newRotation;

                applyTransform(layer, layerType);
            }
        }

        // 触摸结束事件处理
        function handleTouchEnd(e) {
            e.preventDefault();
            if (!touchState.activeLayer) return;

            const layerType = touchState.activeLayer;
            const layer = document.getElementById(layerType + 'Layer');

            layer.classList.remove('interactive');

            // 重置触摸状态
            touchState.isDragging = false;
            touchState.isScaling = false;
            touchState.activeLayer = null;
            touchState.startTouches = [];
            touchState.lastTouches = [];
        }

        // 鼠标事件处理（用于桌面测试）
        function handleMouseDown(e) {
            const layerType = getLayerType(e.target);
            if (!layerType) return;

            touchState.activeLayer = layerType;
            touchState.isDragging = true;
            touchState.initialTransform = { ...layerTransforms[layerType] };

            const fakeTouch = { clientX: e.clientX, clientY: e.clientY };
            touchState.lastTouches = [fakeTouch];

            e.target.classList.add('interactive');
            e.preventDefault();
        }

        function handleMouseMove(e) {
            if (!touchState.isDragging || !touchState.activeLayer) return;

            const layerType = touchState.activeLayer;
            const layer = document.getElementById(layerType + 'Layer');
            const lastTouch = touchState.lastTouches[0];

            const deltaX = e.clientX - lastTouch.clientX;
            const deltaY = e.clientY - lastTouch.clientY;

            layerTransforms[layerType].x += deltaX;
            layerTransforms[layerType].y += deltaY;

            constrainToBounds(layerType);
            applyTransform(layer, layerType);

            touchState.lastTouches = [{ clientX: e.clientX, clientY: e.clientY }];
        }

        function handleMouseUp(e) {
            if (!touchState.activeLayer) return;

            const layerType = touchState.activeLayer;
            const layer = document.getElementById(layerType + 'Layer');

            layer.classList.remove('interactive');

            touchState.isDragging = false;
            touchState.activeLayer = null;
            touchState.lastTouches = [];
        }

        // 点击事件处理（水平翻转）
        function handleLayerClick(e) {
            // 防止拖拽时触发点击
            if (touchState.isDragging || touchState.isScaling) return;

            const layerType = getLayerType(e.target);
            if (!layerType) return;

            const layer = document.getElementById(layerType + 'Layer');

            // 切换翻转状态
            layerTransforms[layerType].flipX = !layerTransforms[layerType].flipX;

            // 添加翻转动画类
            layer.classList.add('flipping');

            applyTransform(layer, layerType);

            // 移除动画类
            setTimeout(() => {
                layer.classList.remove('flipping');
            }, 300);
        }

        // 获取图层类型
        function getLayerType(element) {
            if (element.id === 'bodyLayer') return 'body';
            if (element.id === 'expressionLayer') return 'expression';
            if (element.id === 'textLayer') return 'text';
            return null;
        }

        // 计算两个触摸点之间的距离
        function getTouchDistance(touch1, touch2) {
            const dx = touch2.clientX - touch1.clientX;
            const dy = touch2.clientY - touch1.clientY;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // 计算两个触摸点之间的角度
        function getTouchAngle(touch1, touch2) {
            const dx = touch2.clientX - touch1.clientX;
            const dy = touch2.clientY - touch1.clientY;
            return Math.atan2(dy, dx) * 180 / Math.PI;
        }



        // 重置图层变换
        function resetLayerTransform(layerType) {
            layerTransforms[layerType] = { x: 0, y: 0, scale: 1, rotation: 0, flipX: false };
            const layer = document.getElementById(layerType + 'Layer');
            if (layer) {
                applyTransform(layer, layerType);
            }
        }

        // 重置所有图层变换
        function resetAllTransforms() {
            Object.keys(layerTransforms).forEach(layerType => {
                resetLayerTransform(layerType);
            });
        }

    </script>
</body>
</html>
